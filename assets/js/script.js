// –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JavaScript –¥–ª—è FREE CAD
(function() {
    'use strict';

    // –ö—ç—à DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    const DOMCache = {
        themeIcon: null,
        backToTopBtn: null,
        mobileMenu: null,
        mobileMenuBtn: null,
        contactModal: null,
        privacyModal: null,
        bugReportForm: null,
        
        init() {
            this.themeIcon = document.querySelector('.theme-icon');
            this.backToTopBtn = document.getElementById('backToTop');
            this.mobileMenu = document.getElementById('mobileMenu');
            this.mobileMenuBtn = document.getElementById('mobileMenuBtn');
            this.contactModal = document.getElementById('contactModal');
            this.privacyModal = document.getElementById('privacyModal');
            this.bugReportForm = document.getElementById('bugReportForm');
        }
    };

    // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    const Utils = {
        // Debounce –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã –≤—ã–∑–æ–≤–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π
        debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        },

        // Throttle –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π
        throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        },

        // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–µ–π
        showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏
            Object.assign(notification.style, {
                position: 'fixed',
                top: '20px',
                right: '20px',
                zIndex: '10000',
                background: type === 'success' 
                    ? 'linear-gradient(45deg, #27ae60, #2ecc71)' 
                    : 'linear-gradient(45deg, #e74c3c, #c0392b)',
                color: 'white',
                padding: '15px 25px',
                borderRadius: '25px',
                boxShadow: '0 5px 20px rgba(0,0,0,0.2)',
                fontWeight: 'bold',
                transform: 'translateX(400px)',
                transition: 'transform 0.3s ease',
                maxWidth: '400px',
                wordWrap: 'break-word'
            });

            document.body.appendChild(notification);
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
            requestAnimationFrame(() => {
                notification.style.transform = 'translateX(0)';
            });
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    };

    // Service Worker —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π
    const ServiceWorker = {
        init() {
            if ('serviceWorker' in navigator && 
                (location.protocol === 'https:' || location.hostname === 'localhost')) {
                
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js')
                        .then(registration => {
                            console.log('SW –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', registration);
                        })
                        .catch(error => {
                            console.log('SW —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å:', error);
                        });
                });
            }
        }
    };

    // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–º–æ–π
    const Theme = {
        current: null,
        
        init() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            this.current = savedTheme || (prefersDark ? 'dark' : 'light');
            
            document.documentElement.setAttribute('data-theme', this.current);
            this.updateIcon();
            
            // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
            window.matchMedia('(prefers-color-scheme: dark)')
                .addEventListener('change', (e) => {
                    if (!localStorage.getItem('theme')) {
                        this.current = e.matches ? 'dark' : 'light';
                        document.documentElement.setAttribute('data-theme', this.current);
                        this.updateIcon();
                    }
                });
        },

        toggle() {
            this.current = this.current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', this.current);
            localStorage.setItem('theme', this.current);
            this.updateIcon();
            this.addTransition();
        },

        updateIcon() {
            if (DOMCache.themeIcon) {
                DOMCache.themeIcon.textContent = this.current === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
        },

        addTransition() {
            document.body.style.transition = 'background-color 0.3s ease, color 0.3s ease';
            setTimeout(() => document.body.style.transition = '', 300);
        }
    };

    // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
    const Navigation = {
        init() {
            this.initSmoothScrolling();
            this.initBackToTop();
        },

        initSmoothScrolling() {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
            document.addEventListener('click', (e) => {
                const link = e.target.closest('a[href^="#"]');
                if (!link) return;

                const href = link.getAttribute('href');
                if (href === '#top') {
                    e.preventDefault();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else if (href.startsWith('#')) {
                    e.preventDefault();
                    const targetId = href.substring(1);
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                }
            });
        },

        initBackToTop() {
            if (!DOMCache.backToTopBtn) return;

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º throttle –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ scroll —Å–æ–±—ã—Ç–∏—è
            const handleScroll = Utils.throttle(() => {
                const isVisible = window.pageYOffset > 300;
                DOMCache.backToTopBtn.style.opacity = isVisible ? '1' : '0';
                DOMCache.backToTopBtn.style.visibility = isVisible ? 'visible' : 'hidden';
            }, 100);

            window.addEventListener('scroll', handleScroll, { passive: true });
        }
    };

    // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –º–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é
    const MobileMenu = {
        isOpen: false,

        init() {
            if (!DOMCache.mobileMenu || !DOMCache.mobileMenuBtn) return;
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–µ–Ω—é
            document.addEventListener('click', (e) => {
                if (this.isOpen && 
                    !DOMCache.mobileMenu.contains(e.target) && 
                    !DOMCache.mobileMenuBtn.contains(e.target)) {
                    this.close();
                }
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && this.isOpen) {
                    this.close();
                }
            });
        },

        open() {
            if (!DOMCache.mobileMenu || !DOMCache.mobileMenuBtn) return;
            
            DOMCache.mobileMenu.style.display = 'block';
            DOMCache.mobileMenuBtn.style.display = 'none';
            this.isOpen = true;
            
            requestAnimationFrame(() => {
                DOMCache.mobileMenu.style.opacity = '1';
                DOMCache.mobileMenu.style.transform = 'translateX(0)';
            });
        },

        close() {
            if (!DOMCache.mobileMenu || !DOMCache.mobileMenuBtn) return;
            
            DOMCache.mobileMenu.style.opacity = '0';
            DOMCache.mobileMenu.style.transform = 'translateX(100%)';
            this.isOpen = false;
            
            setTimeout(() => {
                DOMCache.mobileMenu.style.display = 'none';
                DOMCache.mobileMenuBtn.style.display = 'flex';
            }, 300);
        }
    };

    // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
    const Modals = {
        init() {
            this.initContactModal();
            this.initPrivacyModal();
        },

        initContactModal() {
            if (!DOMCache.contactModal) return;

            const form = DOMCache.contactModal.querySelector('form');
            if (form) {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    Utils.showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.');
                    this.closeContactModal();
                    form.reset();
                });
            }
        },

        initPrivacyModal() {
            if (!DOMCache.privacyModal) return;
            
            DOMCache.privacyModal.addEventListener('click', (e) => {
                if (e.target === DOMCache.privacyModal) {
                    this.closePrivacyModal();
                }
            });
        },

        openContactModal() {
            if (DOMCache.contactModal) {
                DOMCache.contactModal.style.display = 'block';
            }
        },

        closeContactModal() {
            if (DOMCache.contactModal) {
                DOMCache.contactModal.style.display = 'none';
            }
        },

        showPrivacyPolicy() {
            if (DOMCache.privacyModal) {
                DOMCache.privacyModal.style.display = 'block';
            }
        },

        closePrivacyModal() {
            if (DOMCache.privacyModal) {
                DOMCache.privacyModal.style.display = 'none';
            }
        }
    };

    // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
    const Forms = {
        init() {
            this.initBugReportForm();
        },

        initBugReportForm() {
            if (!DOMCache.bugReportForm) return;

            DOMCache.bugReportForm.addEventListener('submit', (e) => {
                e.preventDefault();
                Utils.showNotification('–û—Ç—á–µ—Ç –æ–± –æ—à–∏–±–∫–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–º–æ—â—å –≤ —É–ª—É—á—à–µ–Ω–∏–∏ FREE CAD.');
                this.clearBugForm();
            });
        },

        clearBugForm() {
            if (DOMCache.bugReportForm) {
                DOMCache.bugReportForm.reset();
            }
        }
    };

    // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏
    const Animations = {
        init() {
            this.initScrollAnimations();
        },

        initScrollAnimations() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            }, { threshold: 0.1 });

            const elements = document.querySelectorAll(
                '.method-item, .feature-item, .support-card, .tip-box, .warning-box'
            );
            
            elements.forEach(el => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(30px)';
                el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                observer.observe(el);
            });
        }
    };

    // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —ç–∫—Ä–∞–Ω–∞
    const ScreenSize = {
        init() {
            this.checkScreenSize();
            window.addEventListener('resize', 
                Utils.debounce(() => this.checkScreenSize(), 250)
            );
        },

        checkScreenSize() {
            const isMobile = window.innerWidth <= 480;
            
            if (DOMCache.mobileMenuBtn) {
                DOMCache.mobileMenuBtn.style.display = isMobile ? 'flex' : 'none';
            }
            
            if (DOMCache.mobileMenu && !isMobile) {
                MobileMenu.close();
            }
        }
    };

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è HTML (—Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    window.toggleTheme = () => Theme.toggle();
    window.openContactForm = () => Modals.openContactModal();
    window.closeContactModal = () => Modals.closeContactModal();
    window.openMobileMenu = () => MobileMenu.open();
    window.closeMobileMenu = () => MobileMenu.close();
    window.showPrivacyPolicy = () => Modals.showPrivacyPolicy();
    window.closePrivacyModal = () => Modals.closePrivacyModal();
    window.clearBugForm = () => Forms.clearBugForm();

    // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', () => {
        DOMCache.init();
        ServiceWorker.init();
        Theme.init();
        Navigation.init();
        MobileMenu.init();
        Modals.init();
        Forms.init();
        Animations.init();
        ScreenSize.init();
    });

})();